<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin — Edit dashboard data</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: 'Inter', system-ui, sans-serif;
        font-size: 14px;
        background: #f1f3f4;
        color: #1a1a1a;
        line-height: 1.5;
        padding: 24px;
      }
      a { color: #3d82f8; text-decoration: none; }
      a:hover { text-decoration: underline; }
      h1 { font-size: 1.25rem; font-weight: 600; margin: 0 0 8px; }
      .sub { color: #5f6368; font-size: 13px; margin-bottom: 24px; }
      section {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      section h2 { font-size: 1rem; font-weight: 600; margin: 0 0 16px; }
      .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px 24px;
      }
      .field { display: flex; flex-direction: column; gap: 4px; }
      .field label { font-size: 12px; color: #5f6368; font-weight: 500; }
      .field input {
        padding: 8px 10px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        font: inherit;
      }
      .field input:focus { outline: none; border-color: #3d82f8; box-shadow: 0 0 0 2px rgba(61,130,248,0.2); }
      textarea.json {
        width: 100%;
        min-height: 120px;
        padding: 12px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 12px;
        resize: vertical;
      }
      textarea.json:focus { outline: none; border-color: #3d82f8; }
      .json-error { color: #c5221f; font-size: 12px; margin-top: 4px; }
      .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 24px; }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font: inherit;
        font-weight: 500;
        cursor: pointer;
      }
      button.primary { background: #3d82f8; color: #fff; }
      button.primary:hover { background: #2d72e8; }
      button.secondary { background: #e8eaed; color: #1a1a1a; }
      button.secondary:hover { background: #dadce0; }
      .status { font-size: 13px; color: #5f6368; }
      .status.ok { color: #137333; }
      .status.err { color: #c5221f; }
    </style>
  </head>
  <body>
    <a href="/">← Dashboard</a>
    <h1>Admin — Edit dashboard data</h1>
    <p class="sub">Changes are saved to <code>backend/data.json</code>. Dashboard reads from this store.</p>

    <section>
      <h2>Overview</h2>
      <div class="overview-grid">
        <div class="field">
          <label>totalEarnings</label>
          <input type="number" id="totalEarnings" step="0.01" />
        </div>
        <div class="field">
          <label>subscriptions</label>
          <input type="number" id="subscriptions" step="0.01" />
        </div>
        <div class="field">
          <label>tips</label>
          <input type="number" id="tips" step="0.01" />
        </div>
        <div class="field">
          <label>posts</label>
          <input type="number" id="posts" step="0.01" />
        </div>
        <div class="field">
          <label>messages</label>
          <input type="number" id="messages" step="0.01" />
        </div>
        <div class="field">
          <label>referrals</label>
          <input type="number" id="referrals" step="0.01" />
        </div>
        <div class="field">
          <label>streams</label>
          <input type="number" id="streams" step="0.01" />
        </div>
        <div class="field">
          <label>growth</label>
          <input type="number" id="growth" step="0.01" />
        </div>
      </div>
    </section>

    <section>
      <h2>Earnings over time (chart)</h2>
      <p class="sub" style="margin-bottom:12px">Array of <code>{ "date": "Oct 1", "amount": 28400 }</code></p>
      <textarea class="json" id="earningsOverTime" spellcheck="false"></textarea>
      <div class="json-error" id="err-earnings"></div>
    </section>

    <section>
      <h2>Subscriber growth (chart)</h2>
      <p class="sub" style="margin-bottom:12px">Array of <code>{ "month": "Jan", "subs": 14200 }</code></p>
      <textarea class="json" id="subscriberGrowth" spellcheck="false"></textarea>
      <div class="json-error" id="err-subs"></div>
    </section>

    <section>
      <h2>Transactions</h2>
      <p class="sub" style="margin-bottom:12px">Array of <code>{ "date": "31 Oct 2025, 16:12", "type": "Tip", "user": "…", "amount": 25, "net": 21.23 }</code></p>
      <textarea class="json" id="transactions" spellcheck="false"></textarea>
      <div class="json-error" id="err-tx"></div>
    </section>

    <div class="actions">
      <button type="button" class="primary" id="btn-save">Save</button>
      <button type="button" class="secondary" id="btn-load">Load</button>
      <span class="status" id="status"></span>
    </div>

    <script>
      var API = 'http://localhost:3001/api/admin';

      function status(msg, ok) {
        var el = document.getElementById('status');
        el.textContent = msg;
        el.className = 'status ' + (ok === true ? 'ok' : ok === false ? 'err' : '');
      }

      function clearJsonErrors() {
        ['err-earnings', 'err-subs', 'err-tx'].forEach(function (id) {
          var e = document.getElementById(id);
          if (e) e.textContent = '';
        });
      }

      function setOverview(o) {
        if (!o) return;
        var ids = ['totalEarnings', 'subscriptions', 'tips', 'posts', 'messages', 'referrals', 'streams', 'growth'];
        ids.forEach(function (id) {
          var i = document.getElementById(id);
          if (i && o[id] != null) i.value = o[id];
        });
      }

      function getOverview() {
        var o = {};
        ['totalEarnings', 'subscriptions', 'tips', 'posts', 'messages', 'referrals', 'streams', 'growth'].forEach(function (id) {
          var i = document.getElementById(id);
          var v = i ? i.value.trim() : '';
          o[id] = v === '' ? 0 : parseFloat(v);
        });
        return o;
      }

      function setJson(id, arr) {
        var ta = document.getElementById(id);
        if (ta && Array.isArray(arr)) ta.value = JSON.stringify(arr, null, 2);
      }

      function getJson(id, errId) {
        var ta = document.getElementById(id);
        var err = document.getElementById(errId);
        if (!ta) return null;
        var s = ta.value.trim();
        if (s === '') return [];
        try {
          var parsed = JSON.parse(s);
          if (!Array.isArray(parsed)) throw new Error('Must be an array');
          if (err) err.textContent = '';
          return parsed;
        } catch (e) {
          if (err) err.textContent = 'Invalid JSON: ' + e.message;
          return null;
        }
      }

      function load() {
        status('Loading…');
        fetch(API + '/data')
          .then(function (r) { return r.json(); })
          .then(function (data) {
            setOverview(data.overview);
            setJson('earningsOverTime', data.earningsOverTime);
            setJson('subscriberGrowth', data.subscriberGrowth);
            setJson('transactions', data.transactions);
            clearJsonErrors();
            status('Loaded.', true);
          })
          .catch(function (e) {
            status('Load failed: ' + (e.message || 'network error'), false);
          });
      }

      function save() {
        clearJsonErrors();
        var earnings = getJson('earningsOverTime', 'err-earnings');
        var subs = getJson('subscriberGrowth', 'err-subs');
        var tx = getJson('transactions', 'err-tx');
        if (earnings === null || subs === null || tx === null) {
          status('Fix JSON errors above.', false);
          return;
        }
        var payload = {
          overview: getOverview(),
          earningsOverTime: earnings,
          subscriberGrowth: subs,
          transactions: tx
        };
        status('Saving…');
        fetch(API + '/data', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (r) { return r.json(); })
          .then(function () {
            status('Saved. Dashboard will use new data.', true);
          })
          .catch(function (e) {
            status('Save failed: ' + (e.message || 'network error'), false);
          });
      }

      document.getElementById('btn-load').addEventListener('click', load);
      document.getElementById('btn-save').addEventListener('click', save);
      load();
    </script>
  </body>
</html>
